<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habilitación de Alumnos por Juego/Rutina</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-color: #f9f9f9;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }

  .container {
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 20px;
    width: 95%;
    max-width: 1000px;
    min-width: 800px;
    margin-top: 20px;
    background: white;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h2 {
    text-align: center;
    margin: 0;
    font-size: 20px;
  }

  .subtitulo {
    margin: 0;
    text-align: center;
    font-weight: normal;
    margin-bottom: 10px;
  }

  .filters {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
    gap: 20px;
    flex-wrap: wrap;
  }

  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    max-height: 70vh;
    overflow-y: auto;
    margin-top: 10px;
  }

  table {
    border-collapse: collapse;
    font-size: 13px;
    min-width: 800px;
    max-width: 1000px;
    width: max-content;
    margin: auto;
  }

  thead th {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
    background-color: #004080;
    color: white;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  thead th:first-child {
    border-left: 1px solid #ddd;
  }
  thead th:last-child {
    border-right: 1px solid #ddd;
  }

  tbody td {
    border: 1px solid #ddd;
    padding: 5px;
    text-align: center;
    vertical-align: middle;
  }

  tbody tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  tbody tr:hover {
    background-color: #e0f0ff;
  }

  td.student-cell input {
    cursor: pointer;
  }

  th.student-header {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    white-space: nowrap;
    padding: 5px 2px;
  }

  td:first-child, th:first-child {
    white-space: nowrap;
    text-align: left;
    font-weight: bold;
  }

  tr.inactive td {
    color: #999;
    text-decoration: line-through;
  }
</style>
</head>
<body>
<div class="container">
  <h2>HABILITACIÓN DE ALUMNOS PARA JUGAR / RUTINA</h2>
  <div class="subtitulo">
    Docente: <span id="docenteNombre"></span> / Escuela: <span id="escuelaNombre"></span>
  </div>

  <div class="filters">
    <label>Ver listado:
      <select id="tipoListado">
        <option value="juegos">Juegos</option>
        <option value="rutinas">Rutinas</option>
      </select>
    </label>

    <label>Filtrar por curso:
      <select id="filterCurso">
        <option value="">Todos</option>
      </select>
    </label>

    <label>
      <input type="checkbox" id="showInactive" checked> Mostrar usuarios inactivos
    </label>
  </div>

  <div class="table-wrapper">
    <table id="planilla">
      <thead id="thead-alumnos">
        <tr><th>Juego/Rutina</th></tr>
      </thead>
      <tbody id="tbody-juegos"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBVZaysx9d6u6P13DYINPtcinpf79Sgx4U",
  authDomain: "juego001-469b6.firebaseapp.com",
  databaseURL: "https://juego001-469b6-default-rtdb.firebaseio.com",
  projectId: "juego001-469b6",
  storageBucket: "juego001-469b6.appspot.com",
  messagingSenderId: "528847999661",
  appId: "1:528847999661:web:6085a104fe64262a042c24"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const docenteNombre = (localStorage.getItem('nombreApellido') || '').toUpperCase();
const escuelaNombre = localStorage.getItem('tipoEscuela') || '';
document.getElementById('docenteNombre').textContent = docenteNombre;
document.getElementById('escuelaNombre').textContent = escuelaNombre;

let alumnos = [];
let juegos = [];
let habilitados = {};
let allAlumnos = [];
let tipoListado = "juegos";

document.getElementById('tipoListado').addEventListener('change', () => {
  tipoListado = document.getElementById('tipoListado').value;
  cargarDatos();
});

document.getElementById('showInactive').addEventListener('change', applyFilters);
document.getElementById('filterCurso').addEventListener('change', applyFilters);

async function ensureLoggedIn() {
  const user = auth.currentUser;
  if (user) return true;
  const correo = localStorage.getItem('correo');
  const password = localStorage.getItem('password');
  if (!correo || !password) return false;
  try {
    await auth.signInWithEmailAndPassword(correo, password);
    return true;
  } catch(err) {
    alert("Error de autenticación automática: " + err.message);
    return false;
  }
}

async function cargarDatos() {
  try {
    const snapUsuarios = await db.ref('usuarios').once('value');
    const usuarios = snapUsuarios.val() || {};
    allAlumnos = Object.entries(usuarios)
      .filter(([uid,u]) => u.rol === 'alumno' && u.tipoEscuela === escuelaNombre)
      .map(([uid,u]) => ({uid, nombreApellido: u.nombreApellido, curso: u.curso || '', activo: u.activo !== false}));

    const ref = tipoListado === "juegos" ? 'listadejuegos' : 'rutinas';
    const snapItems = await db.ref(ref).once('value');
    const lista = snapItems.val() || {};

    juegos = Object.entries(lista).map(([code, g]) => ({
      gameCode: code,
      titulo: tipoListado === "juegos" ? (g.title || g.name || code) : (g.name || code),
    }));

    habilitados = {};
    for (const {gameCode} of juegos) {
      const snapH = await db.ref(`${ref}/${gameCode}/alumnosHabilitados`).once('value');
      habilitados[gameCode] = snapH.val() || {};
    }

    populateCursoFilter();
    applyFilters();
  } catch(err) {
    alert("Error al cargar la planilla: " + err.message);
  }
}

function populateCursoFilter() {
  const cursos = [...new Set(allAlumnos.map(a=>a.curso).filter(c=>c))].sort();
  const select = document.getElementById('filterCurso');
  select.innerHTML = '<option value="">Todos</option>' + cursos.map(c=>`<option value="${c}">${c}</option>`).join('');
}

function applyFilters() {
  const showInactive = document.getElementById('showInactive').checked;
  const selectedCurso = document.getElementById('filterCurso').value;
  alumnos = allAlumnos.filter(a => (showInactive || a.activo) && (!selectedCurso || a.curso === selectedCurso));
  generarTabla();
}

function generarTabla() {
  const thead = document.getElementById('thead-alumnos');
  const tbody = document.getElementById('tbody-juegos');

  thead.innerHTML = '<tr><th>Juego/Rutina</th></tr>';
  alumnos.forEach(alumno => {
    const th = document.createElement('th');
    th.classList.add('student-header');
    if(!alumno.activo) th.style.color = '#999';
    th.textContent = alumno.nombreApellido;
    thead.querySelector('tr').appendChild(th);
  });

  tbody.innerHTML = '';
  juegos.forEach(juego => {
    const tr = document.createElement('tr');
    const tdJuego = document.createElement('td');
    tdJuego.textContent = juego.titulo;
    tr.appendChild(tdJuego);

    alumnos.forEach(alumno => {
      const td = document.createElement('td');
      td.className = 'student-cell';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = habilitados[juego.gameCode]?.[alumno.uid] || false;

      cb.addEventListener('change', async () => {
         const loggedIn = await ensureLoggedIn();
         if (!loggedIn) return;
         habilitados[juego.gameCode][alumno.uid] = cb.checked;

         const refPath = tipoListado === "juegos" ? "listadejuegos" : "rutinas";

      try {
         await db.ref(`${refPath}/${juego.gameCode}/alumnosHabilitados/${alumno.uid}`).set(cb.checked);
          } catch(err) {
      alert("No se pudo guardar el permiso: " + err.message);
          }
      });


      td.appendChild(cb);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

// Inicializamos
cargarDatos();
</script>
</body>
</html>
